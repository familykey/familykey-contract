# FamilyKey Contract

ä¸€ä¸ªåŸºäºæ™ºèƒ½åˆçº¦çš„èµ„äº§ç»§æ‰¿è§£å†³æ–¹æ¡ˆï¼Œå®ç°äº† Dead Man's Switchï¼ˆæ­»äº¡å¼€å…³ï¼‰æœºåˆ¶ï¼Œç”¨äºè‡ªåŠ¨åŒ–çš„èµ„äº§ä¼ æ‰¿ç®¡ç†ã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

FamilyKey Contract æä¾›äº†ä¸€ç§åˆ›æ–°çš„èµ„äº§ç»§æ‰¿æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·é¢„å…ˆè®¾ç½®å—ç›Šäººï¼Œå½“ç”¨æˆ·åœ¨æŒ‡å®šæ—¶é—´å†…æœªè¿›è¡Œ"å¿ƒè·³ç­¾åˆ°"æ—¶ï¼Œå—ç›Šäººå¯ä»¥å‘èµ·èµ„äº§ç»§æ‰¿æµç¨‹ã€‚é¡¹ç›®æ”¯æŒä¸¤ç§å®ç°æ–¹æ¡ˆï¼š

1. **Safe æ¨¡å—æ–¹æ¡ˆ** - åŸºäº Gnosis Safe å¤šç­¾é’±åŒ…çš„æ¨¡å—åŒ–å®ç°
2. **EIP-7702 æ–¹æ¡ˆ** - åŸºäº EIP-7702 ææ¡ˆçš„ EOAï¼ˆå¤–éƒ¨è´¦æˆ·ï¼‰èµ„äº§ç»§æ‰¿æ–¹æ¡ˆ

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### æ­»äº¡å¼€å…³æœºåˆ¶
- **å¿ƒè·³ç­¾åˆ°**: ç”¨æˆ·å®šæœŸç­¾åˆ°è¯æ˜è´¦æˆ·æ´»è·ƒ
- **è¿‡æœŸæ£€æµ‹**: ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ˜¯å¦è¶…è¿‡å¿ƒè·³é—´éš”æœªç­¾åˆ°
- **ç»§æ‰¿æµç¨‹**: å—ç›Šäººå¯åœ¨ç”¨æˆ·å¤±è”åå‘èµ·ç»§æ‰¿æµç¨‹
- **æŒ‘æˆ˜æœŸ**: è®¾ç½®æŒ‘æˆ˜æœŸï¼Œé˜²æ­¢è¯¯æ“ä½œï¼ŒåŸç”¨æˆ·å¯åœ¨æ­¤æœŸé—´å–æ¶ˆç»§æ‰¿

### èµ„äº§ç®¡ç†
- **ETH è½¬ç§»**: æ”¯æŒè½¬ç§» EOA è´¦æˆ·ä¸­çš„ ETH
- **ERC20 ä»£å¸**: æ”¯æŒæ‰¹é‡è½¬ç§» ERC20 ä»£å¸
- **æ‰¹é‡æ“ä½œ**: ä¸€æ¬¡æ€§è½¬ç§»å¤šç§èµ„äº§
- **å®‰å…¨éªŒè¯**: å¤šé‡éªŒè¯ç¡®ä¿èµ„äº§å®‰å…¨

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### Safe æ¨¡å—æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Safe é’±åŒ…      â”‚
â”‚  (å¤šç­¾è´¦æˆ·)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å¯ç”¨æ¨¡å—
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeadManSwitchModule    â”‚
â”‚ - å¿ƒè·³ç®¡ç†              â”‚
â”‚ - ç»§æ‰¿æµç¨‹æ§åˆ¶          â”‚
â”‚ - æ‰€æœ‰æƒè½¬ç§»            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### EIP-7702 æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EOA è´¦æˆ·            â”‚
â”‚  (é€šè¿‡ EIP-7702      â”‚
â”‚   å§”æ‰˜ä»£ç æ‰§è¡Œ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ çŠ¶æ€ç®¡ç†
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeadManSwitchRegistry    â”‚
â”‚ - Switch é…ç½®å­˜å‚¨        â”‚
â”‚ - å¿ƒè·³è®°å½•               â”‚
â”‚ - ç»§æ‰¿çŠ¶æ€ç®¡ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                  â”‚
           â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeadManSwitch      â”‚  â”‚ AssetTransfer        â”‚
â”‚ Enforcer           â”‚  â”‚ Executor             â”‚
â”‚ - ç»§æ‰¿æ¡ä»¶éªŒè¯     â”‚  â”‚ - ETH è½¬ç§»           â”‚
â”‚ - CaveatEnforcer   â”‚  â”‚ - ERC20 è½¬ç§»         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - æ‰¹é‡èµ„äº§è½¬ç§»       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ åˆçº¦è¯´æ˜

### 1. Safe æ¨¡å—æ–¹æ¡ˆ

#### DeadManSwitchModule.sol
Safe é’±åŒ…çš„æ¨¡å—åˆçº¦ï¼Œç®¡ç†å¿ƒè·³å’Œç»§æ‰¿æµç¨‹ã€‚

**ä¸»è¦åŠŸèƒ½**:
- `checkIn()`: æ‰€æœ‰è€…è¿›è¡Œå¿ƒè·³ç­¾åˆ°
- `startClaim()`: å—ç›Šäººå‘èµ·ç»§æ‰¿æµç¨‹
- `finalizeClaim()`: å®Œæˆç»§æ‰¿ï¼Œè½¬ç§»æ‰€æœ‰æƒ
- `status()`: æŸ¥è¯¢å½“å‰çŠ¶æ€

**å…³é”®å‚æ•°**:
- `safe`: Safe é’±åŒ…åœ°å€
- `beneficiary`: å—ç›Šäººåœ°å€
- `heartbeatInterval`: å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
- `challengePeriod`: æŒ‘æˆ˜æœŸï¼ˆç§’ï¼‰

### 2. EIP-7702 æ–¹æ¡ˆ

#### DeadManSwitchRegistry.sol
çŠ¶æ€å­˜å‚¨åˆçº¦ï¼Œç®¡ç†æ‰€æœ‰ Dead Man's Switch é…ç½®ã€‚

**ä¸»è¦åŠŸèƒ½**:
- `createSwitch()`: åˆ›å»º DMS é…ç½®
- `checkIn()`: å¿ƒè·³ç­¾åˆ°
- `startClaim()`: å‘èµ·ç»§æ‰¿
- `cancelClaim()`: å–æ¶ˆç»§æ‰¿
- `markFinalized()`: æ ‡è®°ç»§æ‰¿å®Œæˆ
- `deactivate()`: ç¦ç”¨é…ç½®

**æŸ¥è¯¢åŠŸèƒ½**:
- `canFinalize()`: æ£€æŸ¥æ˜¯å¦å¯æœ€ç»ˆç»§æ‰¿
- `isExpired()`: æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
- `timeUntilExpiry()`: è·ç¦»è¿‡æœŸçš„å‰©ä½™æ—¶é—´
- `getStatus()`: è·å–å®Œæ•´çŠ¶æ€

#### AssetTransferExecutor.sol
èµ„äº§è½¬ç§»æ‰§è¡Œå™¨ï¼Œè´Ÿè´£æ‰¹é‡è½¬ç§» EOA èµ„äº§ã€‚

**ä¸»è¦åŠŸèƒ½**:
- `batchTransfer()`: æ‰¹é‡è½¬ç§» ETH å’Œ ERC20
- `transferAllETH()`: è½¬ç§»æ‰€æœ‰ ETH
- `transferAllERC20()`: è½¬ç§»æŒ‡å®š ERC20 ä»£å¸å…¨éƒ¨ä½™é¢

**å®‰å…¨ç‰¹æ€§**:
- éªŒè¯å—ç›Šäººèº«ä»½
- æ£€æŸ¥ç»§æ‰¿èµ„æ ¼
- è‡ªåŠ¨æ ‡è®°ç»§æ‰¿å®Œæˆ

#### DeadManSwitchEnforcer.sol
Caveat Enforcer åˆçº¦ï¼Œç»§æ‰¿è‡ª MetaMask Delegation Frameworkã€‚

**ä¸»è¦åŠŸèƒ½**:
- `beforeHook()`: æ‰§è¡Œå‰éªŒè¯ç»§æ‰¿æ¡ä»¶
- `getTerms()`: ç¼–ç éªŒè¯å‚æ•°

**éªŒè¯å†…å®¹**:
- å§”æ‰˜äººèº«ä»½éªŒè¯
- å—ç›Šäººèº«ä»½éªŒè¯
- ç»§æ‰¿èµ„æ ¼éªŒè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- [Foundry](https://book.getfoundry.sh/getting-started/installation)
- Solidity ^0.8.23
- Git

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd familykey-contract

# å®‰è£…ä¾èµ–
forge install

# ç¼–è¯‘åˆçº¦
forge build
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
forge test

# è¿è¡ŒæŒ‡å®šæµ‹è¯•æ–‡ä»¶
forge test --match-path test/DeadManSwitchEIP7702.t.sol

# æ˜¾ç¤ºè¯¦ç»†æµ‹è¯•ä¿¡æ¯
forge test -vvv
```

## ğŸ“¦ éƒ¨ç½²

### éƒ¨ç½² EIP-7702 æ–¹æ¡ˆ

1. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åˆ›å»º .env æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .envï¼Œå¡«å…¥ç§é’¥å’Œ RPC URL
PRIVATE_KEY=your_private_key
RPC_URL=your_rpc_url
```

2. è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
# éƒ¨ç½²åˆ°æµ‹è¯•ç½‘
forge script script/DeployEIP7702.s.sol:DeployEIP7702 \
    --rpc-url $RPC_URL \
    --broadcast \
    --verify

# éƒ¨ç½²åˆ°æœ¬åœ°æµ‹è¯•ç¯å¢ƒ
forge script script/DeployEIP7702.s.sol:DeployEIP7702 \
    --fork-url $RPC_URL
```

3. éƒ¨ç½²è¾“å‡º

éƒ¨ç½²å®Œæˆåä¼šè¾“å‡ºä¸‰ä¸ªåˆçº¦åœ°å€ï¼š
- `DeadManSwitchRegistry`: çŠ¶æ€ç®¡ç†åˆçº¦
- `DeadManSwitchEnforcer`: æ¡ä»¶éªŒè¯åˆçº¦
- `AssetTransferExecutor`: èµ„äº§è½¬ç§»åˆçº¦

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### Safe æ¨¡å—æ–¹æ¡ˆ

```solidity
// 1. éƒ¨ç½²æ¨¡å—
DeadManSwitchModule module = new DeadManSwitchModule(
    safeAddress,
    beneficiaryAddress,
    30 days,  // å¿ƒè·³é—´éš”
    7 days    // æŒ‘æˆ˜æœŸ
);

// 2. Safe å¯ç”¨æ¨¡å—
safe.enableModule(address(module));

// 3. æ‰€æœ‰è€…è¿›è¡Œå¿ƒè·³ç­¾åˆ°
module.checkIn();

// 4. 30å¤©åï¼Œå—ç›Šäººå‘èµ·ç»§æ‰¿
module.startClaim();

// 5. 7å¤©æŒ‘æˆ˜æœŸåï¼Œå®Œæˆç»§æ‰¿
module.finalizeClaim();
```

### EIP-7702 æ–¹æ¡ˆ

```solidity
// 1. éƒ¨ç½²åˆçº¦
DeadManSwitchRegistry registry = new DeadManSwitchRegistry();

// 2. åˆ›å»º Switch é…ç½®
registry.createSwitch(
    beneficiaryAddress,
    30 days,  // å¿ƒè·³é—´éš”
    7 days    // æŒ‘æˆ˜æœŸ
);

// 3. å®šæœŸç­¾åˆ°
registry.checkIn();

// 4. æŸ¥è¯¢çŠ¶æ€
(
    address beneficiary,
    uint256 lastCheckIn,
    uint256 heartbeatInterval,
    uint256 challengePeriod,
    uint256 claimReadyAt,
    bool isActive,
    bool canClaim
) = registry.getStatus(ownerAddress);

// 5. å—ç›Šäººå‘èµ·ç»§æ‰¿
registry.startClaim(ownerAddress);

// 6. æ‰§è¡Œèµ„äº§è½¬ç§»
AssetTransferExecutor executor = new AssetTransferExecutor(address(registry));

// è½¬ç§»æ‰€æœ‰ ETH
executor.transferAllETH(ownerAddress);

// æˆ–æ‰¹é‡è½¬ç§»å¤šç§èµ„äº§
AssetTransferExecutor.AssetTransfer[] memory transfers = new AssetTransferExecutor.AssetTransfer[](2);
transfers[0] = AssetTransferExecutor.AssetTransfer({
    token: address(0),  // ETH
    amount: 1 ether
});
transfers[1] = AssetTransferExecutor.AssetTransfer({
    token: usdcAddress,  // USDC
    amount: 1000e6
});
executor.batchTransfer(ownerAddress, transfers);
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### DeadManSwitchModule æµ‹è¯•
- âœ… å®Œæ•´çš„ç»§æ‰¿æµç¨‹æµ‹è¯•
- âœ… æƒé™éªŒè¯æµ‹è¯•
- âœ… æ—¶é—´é”æµ‹è¯•

### EIP-7702 æ–¹æ¡ˆæµ‹è¯•
- âœ… Registry åˆ›å»ºå’Œç®¡ç†æµ‹è¯•
- âœ… å¿ƒè·³ç­¾åˆ°æµ‹è¯•
- âœ… ç»§æ‰¿æµç¨‹æµ‹è¯•
- âœ… å–æ¶ˆç»§æ‰¿æµ‹è¯•
- âœ… æ—¶é—´æŸ¥è¯¢æµ‹è¯•
- âœ… Enforcer éªŒè¯æµ‹è¯•
- âœ… Executor èµ„äº§è½¬ç§»æµ‹è¯•

è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¦†ç›–ç‡ï¼š

```bash
forge coverage
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å·²å®æ–½çš„å®‰å…¨æªæ–½

1. **æ—¶é—´é”æœºåˆ¶**: æŒ‘æˆ˜æœŸé˜²æ­¢è¯¯æ“ä½œ
2. **æƒé™éªŒè¯**: ä¸¥æ ¼çš„æ‰€æœ‰è€…å’Œå—ç›ŠäººéªŒè¯
3. **çŠ¶æ€æ£€æŸ¥**: å¤šé‡çŠ¶æ€éªŒè¯ç¡®ä¿æµç¨‹æ­£ç¡®æ€§
4. **ä¸å¯å˜å‚æ•°**: å…³é”®å‚æ•°ä½¿ç”¨ immutable é˜²æ­¢ç¯¡æ”¹
5. **é‡å…¥ä¿æŠ¤**: é€‚å½“çš„çŠ¶æ€æ›´æ–°é¡ºåº

### ä½¿ç”¨å»ºè®®

1. **å¿ƒè·³é—´éš”**: å»ºè®®è®¾ç½®ä¸º 30-90 å¤©
2. **æŒ‘æˆ˜æœŸ**: å»ºè®®è®¾ç½®ä¸º 7-30 å¤©
3. **å®šæœŸç­¾åˆ°**: å»ºè®®è®¾ç½®æé†’å®šæœŸç­¾åˆ°
4. **å—ç›Šäººé€‰æ‹©**: é€‰æ‹©å¯ä¿¡ä»»çš„å—ç›Šäººåœ°å€
5. **æµ‹è¯•ç¯å¢ƒ**: å…ˆåœ¨æµ‹è¯•ç½‘å……åˆ†æµ‹è¯•åå†éƒ¨ç½²ä¸»ç½‘

### å·²çŸ¥é™åˆ¶

1. **å•ä¸€å—ç›Šäºº**: å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒå•ä¸€å—ç›Šäºº
2. **EIP-7702 ä¾èµ–**: EIP-7702 æ–¹æ¡ˆéœ€è¦ç½‘ç»œæ”¯æŒè¯¥ææ¡ˆ
3. **Safe ç‰ˆæœ¬**: Safe æ¨¡å—æ–¹æ¡ˆéœ€è¦å…¼å®¹ç‰ˆæœ¬çš„ Safe é’±åŒ…

## ğŸ›£ï¸ è·¯çº¿å›¾

- [x] åŸºç¡€ Safe æ¨¡å—å®ç°
- [x] EIP-7702 æ–¹æ¡ˆå®ç°
- [x] èµ„äº§è½¬ç§»åŠŸèƒ½
- [x] å®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] å¤šå—ç›Šäººæ”¯æŒ
- [ ] æŒ‰æ¯”ä¾‹åˆ†é…èµ„äº§
- [ ] é“¾ä¸‹ç›‘æ§æœåŠ¡
- [ ] Web3 å‰ç«¯ç•Œé¢
- [ ] å®¡è®¡æŠ¥å‘Š

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

---

**å…è´£å£°æ˜**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†çš„å®‰å…¨å®¡è®¡ã€‚åœ¨ä¸»ç½‘éƒ¨ç½²å‰è¯·åŠ¡å¿…è¿›è¡Œå…¨é¢æµ‹è¯•ã€‚
